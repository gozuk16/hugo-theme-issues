{{ define "main" }}
  {{ .Content }}

  <section class="page-list">
    <table class="ticket-table">
      <thead>
        <tr>
          <th>Summary</th>
          <th>Status</th>
          <th>Assignee</th>
          <th>Start Date</th>
          <th>Due Date</th>
        </tr>
      </thead>
      <tbody>
        {{- $pages := .Pages }}

        {{- /* ã‚¨ãƒ”ãƒƒã‚¯ã‚’æŠ½å‡ºã—ã¦ranké †ã«ã‚½ãƒ¼ãƒˆ */ -}}
        {{- $epics := slice }}
        {{- range $pages }}
          {{- if or (eq .Params.issue_type "Epic") (eq .Params.issue_type "ã‚¨ãƒ”ãƒƒã‚¯") }}
            {{- $epics = $epics | append . }}
          {{- end }}
        {{- end }}
        {{- $sortedEpics := sort $epics ".Params.rank" "asc" }}

        {{- /* ã‚¨ãƒ”ãƒƒã‚¯ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤º */ -}}
        {{- range $epic := $sortedEpics }}
          {{- /* ã‚¨ãƒ”ãƒƒã‚¯è¡Œ */ -}}
          <tr>
            <td class="summary-col">
              <span class="issue-type-icon">ğŸŸ£</span>
              <strong>{{ $epic.Params.issue_key }}</strong>:
              <a href="{{ $epic.RelPermalink }}">{{ $epic.Title }}</a>
            </td>
            <td class="status-col">{{ $epic.Params.status }}</td>
            <td class="assignee-col">{{ $epic.Params.assignee }}</td>
            <td class="date-col">{{ $epic.Params.startdate }}</td>
            <td class="date-col">{{ $epic.Params.duedate }}</td>
          </tr>

          {{- /* å­issueã‚’æŠ½å‡ºã—ã¦ranké †ã«ã‚½ãƒ¼ãƒˆ */ -}}
          {{- $epicKey := $epic.Params.issue_key }}
          {{- $children := where $pages ".Params.parent" $epicKey }}
          {{- $sortedChildren := sort $children ".Params.rank" "asc" }}

          {{- /* å­issueã‚’è¡¨ç¤º */ -}}
          {{- range $child := $sortedChildren }}
            <tr>
              <td class="summary-col child-issue">
                <span class="issue-type-icon">
                  {{- with $child.Params.issue_type }}
                    {{- if or (eq . "Story") (eq . "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼") }}ğŸ“—
                    {{- else if or (eq . "Task") (eq . "ã‚¿ã‚¹ã‚¯") }}â˜‘ï¸
                    {{- else if or (eq . "Bug") (eq . "ãƒã‚°") }}ğŸ
                    {{- else }}ğŸ“„
                    {{- end }}
                  {{- end }}
                </span>
                <strong>{{ $child.Params.issue_key }}</strong>:
                <a href="{{ $child.RelPermalink }}">{{ $child.Title }}</a>
              </td>
              <td class="status-col">{{ $child.Params.status }}</td>
              <td class="assignee-col">{{ $child.Params.assignee }}</td>
              <td class="date-col">{{ $child.Params.startdate }}</td>
              <td class="date-col">{{ $child.Params.duedate }}</td>
            </tr>

            {{- /* å­«issueã‚’æŠ½å‡ºã—ã¦ranké †ã«ã‚½ãƒ¼ãƒˆ */ -}}
            {{- $childKey := $child.Params.issue_key }}
            {{- $grandchildren := where $pages ".Params.parent" $childKey }}
            {{- $sortedGrandchildren := sort $grandchildren ".Params.rank" "asc" }}

            {{- /* å­«issueã‚’è¡¨ç¤º */ -}}
            {{- range $grandchild := $sortedGrandchildren }}
              <tr>
                <td class="summary-col grandchild-issue">
                  <span class="issue-type-icon">
                    {{- with $grandchild.Params.issue_type }}
                      {{- if or (eq . "Sub-task") (eq . "Subtask") (eq . "ã‚µãƒ–ã‚¿ã‚¹ã‚¯") }}â¡ï¸
                      {{- else if or (eq . "Task") (eq . "ã‚¿ã‚¹ã‚¯") }}â˜‘ï¸
                      {{- else }}ğŸ“„
                      {{- end }}
                    {{- end }}
                  </span>
                  <strong>{{ $grandchild.Params.issue_key }}</strong>:
                  <a href="{{ $grandchild.RelPermalink }}">{{ $grandchild.Title }}</a>
                </td>
                <td class="status-col">{{ $grandchild.Params.status }}</td>
                <td class="assignee-col">{{ $grandchild.Params.assignee }}</td>
                <td class="date-col">{{ $grandchild.Params.startdate }}</td>
                <td class="date-col">{{ $grandchild.Params.duedate }}</td>
              </tr>
            {{- end }}
          {{- end }}
        {{- end }}

        {{- /* å­¤ç«‹issueã‚’æŠ½å‡ºã—ã¦ranké †ã«ã‚½ãƒ¼ãƒˆ */ -}}
        {{- $epicFamilyKeys := slice }}
        {{- range $sortedEpics }}
          {{- $epicFamilyKeys = $epicFamilyKeys | append .Params.issue_key }}
          {{- $epicKey := .Params.issue_key }}
          {{- $children := where $pages ".Params.parent" $epicKey }}
          {{- range $child := $children }}
            {{- $epicFamilyKeys = $epicFamilyKeys | append $child.Params.issue_key }}
            {{- $childKey := $child.Params.issue_key }}
            {{- $grandchildren := where $pages ".Params.parent" $childKey }}
            {{- range $grandchild := $grandchildren }}
              {{- $epicFamilyKeys = $epicFamilyKeys | append $grandchild.Params.issue_key }}
            {{- end }}
          {{- end }}
        {{- end }}

        {{- $orphans := slice }}
        {{- range $page := $pages }}
          {{- if not (in $epicFamilyKeys $page.Params.issue_key) }}
            {{- $orphans = $orphans | append $page }}
          {{- end }}
        {{- end }}
        {{- $sortedOrphans := sort $orphans ".Params.rank" "asc" }}

        {{- /* å­¤ç«‹issueã‚’è¡¨ç¤º */ -}}
        {{- range $orphan := $sortedOrphans }}
          <tr>
            <td class="summary-col">
              <span class="issue-type-icon">
                {{- with $orphan.Params.issue_type }}
                  {{- if or (eq . "Epic") (eq . "ã‚¨ãƒ”ãƒƒã‚¯") }}ğŸŸ£
                  {{- else if or (eq . "Story") (eq . "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼") }}ğŸ“—
                  {{- else if or (eq . "Task") (eq . "ã‚¿ã‚¹ã‚¯") }}â˜‘ï¸
                  {{- else if or (eq . "Bug") (eq . "ãƒã‚°") }}ğŸ
                  {{- else }}ğŸ“„
                  {{- end }}
                {{- end }}
              </span>
              <strong>{{ $orphan.Params.issue_key }}</strong>:
              <a href="{{ $orphan.RelPermalink }}">{{ $orphan.Title }}</a>
            </td>
            <td class="status-col">{{ $orphan.Params.status }}</td>
            <td class="assignee-col">{{ $orphan.Params.assignee }}</td>
            <td class="date-col">{{ $orphan.Params.startdate }}</td>
            <td class="date-col">{{ $orphan.Params.duedate }}</td>
          </tr>
        {{- end }}
      </tbody>
    </table>
  </section>
{{ end }}

{{ define "sidebar" }}
  <section class="widget">
    <h3>In This Section</h3>
    <p>{{ .Params.description | default "Browse all pages in this section." }}</p>
    <p><strong>Total pages:</strong> {{ len .Pages }}</p>
  </section>

  {{ partial "sidebar-right.html" . }}
{{ end }}
