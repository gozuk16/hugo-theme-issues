<!DOCTYPE html>
<html lang="{{ site.Language.LanguageCode }}" dir="{{ or site.Language.LanguageDirection `ltr` }}">
<head>
  {{ partial "head.html" . }}
</head>
<body{{ if .IsHome }} class="is-home"{{ end }}>
  <header>
    {{ partial "header.html" . }}
  </header>

  {{- if .IsHome }}
  <main-home>
    {{ block "main" . }}{{ end }}
  </main-home>
  {{- else }}
  <aside class="sidebar-left">
    {{ partial "sidebar-left.html" . }}
  </aside>

  <main>
    {{ block "main" . }}{{ end }}
  </main>
  {{- end }}

  <aside class="sidebar-right">
    {{ block "sidebar" . }}
      {{ partial "sidebar-right.html" . }}
    {{ end }}
  </aside>

  {{- if .IsHome }}
  <footer>
    {{ partial "footer.html" . }}
  </footer>
  {{- end }}

  <script>
    window.addEventListener('DOMContentLoaded', (event) => {
      new PagefindUI({ element: "#search", showSubResults: true });

      // 矢印キーナビゲーション
      let selectedIndex = -1;
      const searchContainer = document.getElementById('search');

      searchContainer.addEventListener('keydown', (e) => {
        const results = searchContainer.querySelectorAll('.pagefind-ui__result');
        const loadMoreBtn = searchContainer.querySelector('.pagefind-ui__button');
        const totalItems = results.length + (loadMoreBtn ? 1 : 0);
        if (totalItems === 0) return;

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, totalItems - 1);
          updateSelection(results, loadMoreBtn);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, 0);
          updateSelection(results, loadMoreBtn);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          if (selectedIndex < results.length) {
            const link = results[selectedIndex].querySelector('a');
            if (link) link.click();
          } else if (loadMoreBtn) {
            loadMoreBtn.click();
            selectedIndex = -1;
          }
        } else if (e.key === 'Escape') {
          selectedIndex = -1;
          updateSelection(results, loadMoreBtn);
        }
      });

      // 検索入力時にリセット
      searchContainer.addEventListener('input', () => {
        selectedIndex = -1;
      });

      function updateSelection(results, loadMoreBtn) {
        results.forEach((r, i) => {
          r.classList.toggle('pagefind-ui__result--selected', i === selectedIndex);
        });
        if (loadMoreBtn) {
          loadMoreBtn.classList.toggle('pagefind-ui__button--selected', selectedIndex === results.length);
        }
        if (selectedIndex >= 0) {
          const target = selectedIndex < results.length ? results[selectedIndex] : loadMoreBtn;
          if (target) target.scrollIntoView({ block: 'nearest' });
        }
      }
    });
  </script>
</body>
</html>
